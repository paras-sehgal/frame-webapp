<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>FRAME – Query</title>
<style>
  :root {
    --bg:#0f0f14; --panel:#141821; --text:#eaeaf2; --muted:#a8acc2;
    --accent:#8b5cf6; --accent2:#f59e0b; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.35 ui-sans-serif,system-ui,-apple-system}
  .wrap{max-width:960px;margin:40px auto;padding:0 16px}
  .card{background:var(--panel);border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.35);padding:18px;margin-bottom:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  input,select,textarea,button{font:inherit}
  textarea, input, select{background:#0c0f15;color:var(--text);border:1px solid #242a38;border-radius:10px;padding:12px}
  textarea{width:100%;min-height:110px;resize:vertical}
  select{padding:10px 12px}
  .btn{background:var(--accent);border:none;color:white;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn.secondary{background:#263043}
  .btn.ghost{background:transparent;border:1px solid #384156}
  .pill{display:inline-block;background:#1d2230;border:1px solid #2a3042;color:var(--muted);padding:6px 10px;border-radius:999px;margin-right:6px;cursor:pointer}
  pre{background:#0b0e14;border:1px solid #1e2433;border-radius:10px;padding:12px;overflow:auto;white-space:pre-wrap}
  .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .logo{font-weight:800;letter-spacing:.25em;color:white}
  .status.ok{color:var(--ok)} .status.err{color:var(--err)} .status.warn{color:var(--warn)}
  .debug-info{background:#1a1d2e;border:1px solid #2a3042;border-radius:8px;padding:10px;margin-top:10px;font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card hdr">
    <div class="logo">F R A M E</div>
    <div>
      <span id="who" class="pill">signed-out</span>
      <button id="btnSignIn" class="btn">Sign in</button>
      <button id="btnSignOut" class="btn secondary" style="display:none">Sign out</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="align-items:center;gap:12px;margin-bottom:12px">
      <label>Dataset:&nbsp;
        <select id="dataset">
          <option value="movies">Movies</option>
          <option value="analytics">Analytics</option>
        </select>
      </label>
      <span id="envNote" class="pill">checking environment...</span>
    </div>

    <textarea id="nlq" placeholder="Ask a question (e.g., Top 10 movies worldwide since 2010)"></textarea>

    <div class="row" style="margin-top:10px">
      <button id="btnGen" class="btn">Generate SQL</button>
      <button id="btnRun" class="btn secondary">Run</button>
      <button id="btnSave" class="btn ghost">Save</button>
      <button id="btnCopySQL" class="btn ghost">Copy SQL</button>
      <button id="btnTest" class="btn ghost">Test Backend</button>
    </div>

    <div style="margin-top:10px">
      <span class="pill sug">Top 10 movies since 2010</span>
      <span class="pill sug">Average IMDb rating by genre (2015–2025)</span>
      <span class="pill sug">Directors with most Oscar wins since 1990</span>
    </div>
  </div>

  <div class="card">
    <div style="margin-bottom:6px;color:var(--muted)">Output</div>
    <input id="echo" style="width:100%" readonly />
    <div style="margin-top:8px;color:var(--muted)">SQL</div>
    <pre id="sqlPre"></pre>
    <div style="margin-top:8px;color:var(--muted)">Result</div>
    <pre id="resultPre"></pre>
    <div style="margin-top:8px">Worker: <span id="workerBeat" class="status warn">checking…</span></div>
    
    <!-- Debug Information -->
    <div class="debug-info" id="debugInfo">
      <div>Firebase Status: <span id="firebaseStatus">initializing...</span></div>
      <div>Auth Status: <span id="authStatus">checking...</span></div>
      <div>Firestore Status: <span id="firestoreStatus">checking...</span></div>
      <div id="errorLog"></div>
    </div>
  </div>

  <div class="card" style="text-align:center;color:var(--muted)">
    FRAME · Query-first · Firebase Auth & Firestore · <span id="proj"></span>
  </div>
</div>

<!-- Firebase SDKs (modular v10 - latest stable) -->
<script type="module">
  // Enable App Check debug for localhost
  self.FIREBASE_APPCHECK_DEBUG_TOKEN = true;

  // Import Firebase modules from latest CDN
  import { initializeApp, getApps, deleteApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithPopup, 
    GoogleAuthProvider, 
    signOut,
    connectAuthEmulator
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
    getFirestore, 
    collection, 
    addDoc, 
    serverTimestamp, 
    onSnapshot, 
    query, 
    where, 
    orderBy, 
    limit,
    connectFirestoreEmulator,
    enableNetwork,
    disableNetwork,
    doc,
    getDocs
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase configuration - CRITICAL: projectId must match exactly
  const firebaseConfig = {
    apiKey: "AIzaSyAaUpJhk-oopTDn_HnQvqQUMQxPHNlz3S8",
    authDomain: "frame-app-498.firebaseapp.com",
    projectId: "frame-app-498",  // THIS MUST BE EXACT
    storageBucket: "frame-app-498.firebasestorage.app",  // Updated storage URL
    messagingSenderId: "252007542857",
    appId: "1:252007542857:web:b4ffa3e81e7f120b434f98",
    measurementId: "G-GWBXV2KBQM"
  };

  // Debug logging
  const logDebug = (message, type = 'info') => {
    console.log(`[FRAME] ${message}`);
    const errorLog = document.getElementById('errorLog');
    if (type === 'error' && errorLog) {
      errorLog.innerHTML = `<div style="color: var(--err)">Error: ${message}</div>`;
    }
  };

  // Initialize Firebase with proper error handling
  let app, auth, db;
  
  try {
    // Clear any existing Firebase apps to avoid conflicts
    const { getApps, deleteApp } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js");
    const existingApps = getApps();
    
    // If there's an existing app with wrong config, delete it
    for (const existingApp of existingApps) {
      if (existingApp.options.projectId !== 'frame-app-498') {
        console.warn('Deleting misconfigured Firebase app');
        await deleteApp(existingApp);
      }
    }
    
    // Initialize fresh
    app = initializeApp(firebaseConfig);
    console.log('✅ Firebase initialized with project:', firebaseConfig.projectId);
    document.getElementById('firebaseStatus').textContent = 'initialized ✓';
    logDebug('Firebase app initialized successfully');
  } catch (error) {
    console.error('❌ Firebase initialization error:', error);
    document.getElementById('firebaseStatus').textContent = 'failed ✗';
    logDebug(`Failed to initialize Firebase: ${error.message}`, 'error');
  }

  try {
    auth = getAuth(app);
    document.getElementById('authStatus').textContent = 'ready';
    logDebug('Auth initialized');
  } catch (error) {
    document.getElementById('authStatus').textContent = 'failed ✗';
    logDebug(`Failed to initialize Auth: ${error.message}`, 'error');
  }

  try {
    db = getFirestore(app);
    document.getElementById('firestoreStatus').textContent = 'connected';
    logDebug('Firestore initialized');
    
    // Test Firestore connection
    enableNetwork(db).then(() => {
      document.getElementById('firestoreStatus').textContent = 'connected ✓';
      logDebug('Firestore network enabled');
    }).catch(err => {
      document.getElementById('firestoreStatus').textContent = 'offline';
      logDebug(`Firestore network error: ${err.message}`, 'error');
    });
  } catch (error) {
    document.getElementById('firestoreStatus').textContent = 'failed ✗';
    logDebug(`Failed to initialize Firestore: ${error.message}`, 'error');
  }

  document.getElementById('proj').textContent = firebaseConfig.projectId;
  
  // Test Firestore connection immediately
  console.log('🔥 Firebase initialized with project:', firebaseConfig.projectId);
  console.log('📊 Testing Firestore connection...');
  
  // Try to read from Firestore to test connection
  const testConnection = async () => {
    try {
      const testQuery = query(collection(db, 'queries'), limit(1));
      const snapshot = await getDocs(testQuery);
      console.log('✅ Firestore connection successful! Found', snapshot.size, 'documents');
      document.getElementById('firestoreStatus').textContent = 'connected ✓';
    } catch (error) {
      console.error('❌ Firestore connection failed:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      document.getElementById('firestoreStatus').textContent = `failed: ${error.code}`;
      
      if (error.code === 'permission-denied') {
        console.error('🔒 Permission denied - check Firestore rules');
      } else if (error.code === 'unavailable') {
        console.error('🌐 Network issue - check internet connection');
      }
    }
  };
  
  // Test after a short delay to ensure everything is initialized
  setTimeout(testConnection, 1000);

  // Simple NL → SQL stub with more examples
  function nl2sql(nlq, dataset) {
    nlq = (nlq || "").toLowerCase();
    if (dataset === 'movies') {
      if (nlq.includes('top 10') && nlq.includes('since 2010')) {
        return `-- Top 10 movies by worldwide gross since 2010\nSELECT title, worldwide_gross, release_year\nFROM movies\nWHERE release_year >= 2010\nORDER BY worldwide_gross DESC\nLIMIT 10;`;
      }
      if (nlq.includes('average') && nlq.includes('rating')) {
        return `-- Average IMDb rating by genre\nSELECT genre, AVG(imdb_rating) as avg_rating\nFROM movies\nWHERE release_year BETWEEN 2015 AND 2025\nGROUP BY genre\nORDER BY avg_rating DESC;`;
      }
      if (nlq.includes('directors') && nlq.includes('oscar')) {
        return `-- Directors with most Oscar wins\nSELECT director, COUNT(*) as oscar_wins\nFROM movies\nWHERE oscar_wins > 0 AND release_year >= 1990\nGROUP BY director\nORDER BY oscar_wins DESC\nLIMIT 10;`;
      }
    }
    return `-- Generated SQL for: ${nlq}\nSELECT * FROM ${dataset} LIMIT 50;`;
  }

  const $ = sel => document.querySelector(sel);
  
  function toast(msg) { 
    console.log(msg);
    // Create a temporary toast notification
    const toastEl = document.createElement('div');
    toastEl.style.cssText = 'position:fixed;top:20px;right:20px;background:var(--accent);color:white;padding:12px 20px;border-radius:8px;z-index:1000';
    toastEl.textContent = msg;
    document.body.appendChild(toastEl);
    setTimeout(() => toastEl.remove(), 3000);
  }

  const who = $('#who');
  const btnSignIn = $('#btnSignIn');
  const btnSignOut = $('#btnSignOut');

  btnSignIn.onclick = async () => {
    try {
      logDebug('Attempting sign in...');
      const provider = new GoogleAuthProvider();
      const result = await signInWithPopup(auth, provider);
      logDebug(`Sign in successful: ${result.user.email}`);
      toast('Signed in successfully!');
    } catch(e) { 
      logDebug(`Sign-in error: ${e.message}`, 'error');
      alert('Sign-in error: ' + e.message); 
    }
  };

  btnSignOut.onclick = async () => {
    try {
      await signOut(auth);
      toast('Signed out');
      logDebug('Signed out successfully');
    } catch(e) {
      logDebug(`Sign-out error: ${e.message}`, 'error');
    }
  };

  // Auth state observer
  onAuthStateChanged(auth, user => {
    if (user) {
      who.textContent = user.email;
      btnSignIn.style.display = 'none';
      btnSignOut.style.display = 'inline-block';
      document.getElementById('authStatus').textContent = `authenticated (${user.email})`;
      logDebug(`Auth state changed: signed in as ${user.email}`);
    } else {
      who.textContent = 'signed-out';
      btnSignIn.style.display = 'inline-block';
      btnSignOut.style.display = 'none';
      document.getElementById('authStatus').textContent = 'not authenticated';
      logDebug('Auth state changed: signed out');
    }
  });

  // Suggestion pills
  document.querySelectorAll('.sug').forEach(s => {
    s.addEventListener('click', () => {
      $('#nlq').value = s.textContent;
      toast('Query loaded');
    });
  });

  // Generate SQL button
  $('#btnGen').onclick = () => {
    const q = $('#nlq').value.trim();
    if (!q) {
      toast('Please enter a question first');
      return;
    }
    const ds = $('#dataset').value;
    const sql = nl2sql(q, ds);
    $('#echo').value = q;
    $('#sqlPre').textContent = sql;
    toast('SQL generated');
  };

  // Save button
  $('#btnSave').onclick = async () => {
    const u = auth.currentUser;
    if (!u) { 
      alert('Please sign in first'); 
      return; 
    }
    
    console.log('Current user:', u.email, 'UID:', u.uid);
    
    const qtext = $('#nlq').value.trim();
    if (!qtext) { 
      alert('Please type a question first'); 
      return; 
    }
    
    const ds = $('#dataset').value;
    const sql = nl2sql(qtext, ds);
    
    console.log('Preparing to save:', {
      query: qtext,
      dataset: ds,
      sql: sql,
      user: u.uid
    });

    try {
      logDebug('Attempting to save query to Firestore...');
      console.log('Creating document in Firestore...');
      
      const docRef = await addDoc(collection(db, 'queries'), {
        user_id: u.uid,
        user_email: u.email,
        input: qtext,
        dataset: ds,
        sql: sql,
        status: 'pending',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        output: ''
      });
      
      console.log('✅ Document created successfully!', docRef.id);
      console.log('Check Firestore at:', `https://console.firebase.google.com/project/frame-app-498/firestore/data/~2Fqueries~2F${docRef.id}`);
      
      toast('Query saved: ' + docRef.id);
      logDebug(`Query saved with ID: ${docRef.id}`);
      listenForMyLatest(u.uid);
    } catch(e) {
      console.error("❌ Save failed - Full error:", e);
      logDebug(`Save failed: ${e.message}`, 'error');
      alert('Save failed: ' + e.message + '\n\nError code: ' + (e.code || 'unknown') + '\n\nPlease check the browser console for details.');
    }
  };

  $('#btnRun').onclick = () => $('#btnSave').click();

  $('#btnCopySQL').onclick = async () => {
    const sqlText = $('#sqlPre').textContent;
    if (!sqlText) {
      toast('No SQL to copy');
      return;
    }
    try {
      await navigator.clipboard.writeText(sqlText);
      toast('SQL copied to clipboard');
    } catch(e) { 
      toast('Copy failed - please select and copy manually'); 
    }
  };

  // Test backend connection
  $('#btnTest').onclick = async () => {
    const u = auth.currentUser;
    if (!u) { 
      alert('Please sign in first'); 
      return; 
    }
    
    try {
      logDebug('Testing backend connection...');
      const testDoc = await addDoc(collection(db, 'queries'), {
        user_id: u.uid,
        user_email: u.email,
        input: 'SELECT COUNT(*) as test_count FROM frame-app-498.dataset_cur_movies.view_cur_movies LIMIT 1',
        dataset: 'movies',
        sql: 'SELECT COUNT(*) as test_count FROM frame-app-498.dataset_cur_movies.view_cur_movies LIMIT 1',
        status: 'pending',
        is_test: true,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      toast('Test query sent: ' + testDoc.id);
      logDebug(`Test document created: ${testDoc.id}`);
      
      // Monitor this specific document
      const unsubTest = onSnapshot(doc(db, 'queries', testDoc.id), (doc) => {
        const data = doc.data();
        if (data.status === 'completed' || data.status === 'done') {
          toast('✓ Backend is working!');
          logDebug('Backend test successful');
          unsubTest();
        } else if (data.status === 'error' || data.status === 'failed') {
          toast('✗ Backend error - check logs');
          logDebug('Backend test failed: ' + (data.error || 'Unknown error'));
          unsubTest();
        }
      });
      
      // Timeout after 30 seconds
      setTimeout(() => {
        unsubTest();
        toast('Backend test timed out - may not be running');
      }, 30000);
      
    } catch(e) {
      logDebug(`Test failed: ${e.message}`, 'error');
      alert('Test failed: ' + e.message);
    }
  };

  // Listen for latest query updates
  let unSubLatest = null;
  let currentDocId = null;
  
  async function listenForMyLatest(uid) {
    if (unSubLatest) { 
      unSubLatest(); 
      unSubLatest = null; 
    }
    
    try {
      logDebug(`Setting up listener for user ${uid}`);
      const q = query(
        collection(db, 'queries'),
        where('user_id', '==', uid),
        orderBy('createdAt', 'desc'),
        limit(1)
      );
      
      unSubLatest = onSnapshot(q, 
        snapshot => {
          snapshot.docChanges().forEach(change => {
            const data = change.doc.data() || {};
            const docId = change.doc.id;
            
            // Store current doc ID for direct monitoring
            if (change.type === 'added') {
              currentDocId = docId;
              listenToSpecificDoc(docId);
            }
            
            logDebug(`Received update for doc ${docId}: status=${data.status}`);
            
            // Display the results based on what's available
            if (data.output) {
              $('#resultPre').textContent = data.output;
            } else if (data.rows) {
              $('#resultPre').textContent = typeof data.rows === 'string' ? data.rows : JSON.stringify(data.rows, null, 2);
            } else if (data.raw_output) {
              $('#resultPre').textContent = data.raw_output;
            } else if (data.result) {
              $('#resultPre').textContent = typeof data.result === 'string' ? data.result : JSON.stringify(data.result, null, 2);
            } else {
              $('#resultPre').textContent = 'Processing query...';
            }
            
            const st = data.status || 'pending';
            const badge = $('#workerBeat');
            
            if (st === 'completed' || st === 'done') { 
              badge.textContent = 'completed'; 
              badge.className = 'status ok'; 
            } else if (st === 'running' || st === 'processing') { 
              badge.textContent = 'processing…'; 
              badge.className = 'status warn'; 
            } else if (st === 'error' || st === 'failed') { 
              badge.textContent = 'error'; 
              badge.className = 'status err'; 
              if (data.error) {
                $('#resultPre').textContent = `Error: ${data.error}`;
              }
            } else { 
              badge.textContent = 'pending…'; 
              badge.className = 'status warn'; 
            }
          });
        },
        error => {
          logDebug(`Listener error: ${error.message}`, 'error');
          console.error('Listener error:', error);
        }
      );
    } catch(e) {
      logDebug(`Failed to set up listener: ${e.message}`, 'error');
    }
  }
  
  // Listen to specific document for real-time updates
  function listenToSpecificDoc(docId) {
    if (!docId) return;
    
    const docRef = doc(db, 'queries', docId);
    onSnapshot(docRef, (doc) => {
      if (doc.exists()) {
        const data = doc.data();
        logDebug(`Direct doc update: ${docId}, status: ${data.status}`);
        
        // Update display with latest data
        if (data.output || data.raw_output || data.result) {
          const output = data.output || data.raw_output || data.result;
          $('#resultPre').textContent = typeof output === 'string' ? output : JSON.stringify(output, null, 2);
        }
      }
    });
  }

  // Set up listener when auth state changes
  onAuthStateChanged(auth, user => {
    if (user) {
      listenForMyLatest(user.uid);
    } else {
      if (unSubLatest) { 
        unSubLatest(); 
        unSubLatest = null; 
      }
      $('#resultPre').textContent = '';
      $('#workerBeat').textContent = 'signed out';
      $('#workerBeat').className = 'status warn';
    }
  });

  // Check environment
  if (location.protocol === 'file:') {
    $('#envNote').textContent = '⚠️ Open via http://localhost (Auth blocked on file://)';
    $('#envNote').style.background = 'var(--err)';
    logDebug('Running from file:// protocol - auth will not work', 'error');
  } else {
    $('#envNote').textContent = '✓ ' + location.origin;
    $('#envNote').style.background = 'var(--ok)';
    $('#envNote').style.color = 'white';
    logDebug(`Running from ${location.origin}`);
  }
</script>
</body>
</html>